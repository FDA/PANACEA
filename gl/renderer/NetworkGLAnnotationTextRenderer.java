package com.eng.cber.na.gl.renderer;

import java.awt.geom.Point2D;
import java.nio.CharBuffer;

import javax.media.opengl.GL2;
import javax.media.opengl.GLAutoDrawable;

import com.eng.cber.na.annotations.NetworkGLAnnotation;
import com.eng.cber.na.gl.GLRenderContext;
import com.eng.cber.na.layout.Layout;

/**
 * Rendering class for String annotations.
 * 
 * @param <V>
 * @param <E>
 * @param <T>
 */

public class NetworkGLAnnotationTextRenderer<V,E> implements GLRenderer.AnnotationTextRenderer<V, E> {
	/* 0x20 through 0x7A */
	// this defines the font
	private static final byte[][] CHARSET = {
		{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x08,0x08,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x22,0x22,0x22,0x22,0x00,0x00},
		{0x00,0x00,0x48,0x48,0x48,0x7E,0x24,0x24,0x7E,0x12,0x12,0x12,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x08,0x3E,0x49,0x09,0x0E,0x38,0x48,0x49,0x3E,0x08,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x46,0x29,0x29,0x16,0x08,0x08,0x34,0x4A,0x4A,0x31,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x39,0x46,0x42,0x45,0x39,0x1C,0x22,0x22,0x22,0x1C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x00,0x00},
		{0x00,0x04,0x08,0x08,0x10,0x10,0x10,0x10,0x10,0x10,0x08,0x08,0x04,0x00,0x00,0x00},
		{0x00,0x20,0x10,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x10,0x10,0x20,0x00,0x00,0x00},
		{0x00,0x00,0x00,0x08,0x49,0x2A,0x1C,0x2A,0x49,0x08,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x00,0x08,0x08,0x08,0x7F,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x10,0x08,0x08,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x40,0x40,0x20,0x10,0x10,0x08,0x08,0x04,0x02,0x02,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x18,0x24,0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x28,0x18,0x08,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x7E,0x40,0x40,0x20,0x10,0x0C,0x02,0x42,0x42,0x3C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x42,0x02,0x02,0x1C,0x02,0x42,0x42,0x3C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x04,0x04,0x04,0x7E,0x44,0x44,0x24,0x14,0x0C,0x04,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x02,0x02,0x02,0x7C,0x40,0x40,0x40,0x7E,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x42,0x42,0x42,0x7C,0x40,0x40,0x20,0x1C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x08,0x08,0x08,0x08,0x04,0x04,0x04,0x02,0x02,0x7E,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x42,0x42,0x42,0x3C,0x42,0x42,0x42,0x3C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x38,0x04,0x02,0x02,0x02,0x3E,0x42,0x42,0x42,0x3C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x10,0x08,0x08,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x02,0x04,0x08,0x10,0x20,0x10,0x08,0x04,0x02,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x40,0x20,0x10,0x08,0x04,0x08,0x10,0x20,0x40,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x08,0x08,0x00,0x08,0x08,0x04,0x02,0x42,0x42,0x3C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x1E,0x20,0x4E,0x52,0x52,0x52,0x56,0x4A,0x22,0x1C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x42,0x42,0x42,0x7E,0x42,0x42,0x24,0x24,0x18,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x7C,0x42,0x42,0x42,0x42,0x7C,0x42,0x42,0x42,0x7C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x42,0x40,0x40,0x40,0x40,0x42,0x42,0x3C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x78,0x44,0x42,0x42,0x42,0x42,0x42,0x42,0x44,0x78,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x7E,0x40,0x40,0x40,0x40,0x7C,0x40,0x40,0x40,0x7E,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x40,0x40,0x40,0x40,0x40,0x7C,0x40,0x40,0x40,0x7E,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3A,0x46,0x42,0x42,0x4E,0x40,0x40,0x42,0x42,0x3C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x42,0x42,0x42,0x42,0x7E,0x42,0x42,0x42,0x42,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x38,0x44,0x44,0x04,0x04,0x04,0x04,0x04,0x04,0x1F,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x44,0x48,0x50,0x60,0x60,0x50,0x48,0x44,0x42,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x7E,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x42,0x42,0x42,0x5A,0x5A,0x66,0x66,0x42,0x42,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x46,0x46,0x4A,0x4A,0x52,0x52,0x62,0x62,0x42,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x40,0x40,0x40,0x40,0x40,0x7C,0x42,0x42,0x42,0x7C,0x00,0x00,0x00,0x00},
		{0x00,0x03,0x3C,0x66,0x5A,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x42,0x44,0x44,0x48,0x7C,0x42,0x42,0x42,0x7C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x42,0x02,0x0C,0x30,0x40,0x42,0x42,0x3C,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x7F,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x08,0x08,0x14,0x14,0x22,0x22,0x22,0x41,0x41,0x41,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x42,0x66,0x66,0x5A,0x5A,0x42,0x42,0x42,0x42,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x42,0x24,0x24,0x18,0x18,0x24,0x24,0x42,0x42,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x14,0x22,0x22,0x41,0x41,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x7E,0x40,0x40,0x20,0x10,0x08,0x04,0x02,0x02,0x7E,0x00,0x00,0x00,0x00},
		{0x00,0x0E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x0E,0x00,0x00,0x00},
		{0x00,0x00,0x02,0x02,0x04,0x08,0x08,0x10,0x10,0x20,0x40,0x40,0x00,0x00,0x00,0x00},
		{0x00,0x70,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x70,0x00,0x00,0x00},
		{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x42,0x24,0x18,0x00,0x00},
		{0x00,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x10,0x20,0x00},
		{0x00,0x00,0x3A,0x46,0x42,0x42,0x3E,0x02,0x42,0x3C,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x5C,0x62,0x42,0x42,0x42,0x42,0x62,0x5C,0x40,0x40,0x40,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x40,0x40,0x40,0x40,0x42,0x3C,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3A,0x46,0x42,0x42,0x42,0x42,0x46,0x3A,0x02,0x02,0x02,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x40,0x40,0x7E,0x42,0x42,0x3C,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x10,0x10,0x10,0x10,0x10,0x10,0x7C,0x10,0x10,0x10,0x0C,0x00,0x00,0x00},
		{0x3C,0x42,0x42,0x3C,0x20,0x38,0x44,0x44,0x44,0x3A,0x02,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x42,0x42,0x42,0x42,0x42,0x62,0x5C,0x40,0x40,0x40,0x00,0x00,0x00},
		{0x00,0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x18,0x00,0x08,0x08,0x00,0x00,0x00},
		{0x30,0x48,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x0C,0x00,0x04,0x04,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x44,0x48,0x50,0x60,0x50,0x48,0x44,0x40,0x40,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x18,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x49,0x49,0x49,0x49,0x49,0x49,0x49,0x76,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x42,0x42,0x42,0x42,0x42,0x62,0x5C,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x40,0x40,0x5C,0x62,0x42,0x42,0x42,0x42,0x62,0x5C,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x02,0x02,0x3A,0x46,0x42,0x42,0x42,0x42,0x46,0x3A,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x40,0x40,0x40,0x40,0x40,0x42,0x62,0x5C,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3C,0x42,0x02,0x0C,0x30,0x40,0x42,0x3C,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x0C,0x10,0x10,0x10,0x10,0x10,0x10,0x7C,0x10,0x10,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x3A,0x46,0x42,0x42,0x42,0x42,0x42,0x42,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x18,0x18,0x24,0x24,0x24,0x42,0x42,0x42,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x36,0x49,0x49,0x49,0x49,0x49,0x49,0x41,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x42,0x42,0x24,0x18,0x18,0x24,0x42,0x42,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x3C,0x02,0x02,0x1A,0x26,0x42,0x42,0x42,0x42,0x42,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x00,0x7E,0x40,0x20,0x10,0x08,0x04,0x02,0x7E,0x00,0x00,0x00,0x00,0x00,0x00},
		{0x00,0x0C,0x10,0x10,0x08,0x08,0x10,0x10,0x08,0x08,0x10,0x10,0x0C,0x00,0x00,0x00},
		{0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00},
		{0x00,0x30,0x08,0x08,0x10,0x10,0x08,0x08,0x10,0x10,0x08,0x08,0x30,0x00,0x00,0x00},
		{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x46,0x49,0x31,0x00,0x00,0x00}
	};
		
	private int charsetOffset;
	
	// Implemented using a rasterized font and display lists
	public NetworkGLAnnotationTextRenderer(GLAutoDrawable glautodrawable) {
		GL2 gl2 = glautodrawable.getGL().getGL2();
		charsetOffset = gl2.glGenLists(0x20 + CHARSET.length);
		gl2.glPixelStorei(GL2.GL_UNPACK_ALIGNMENT, 1);
		for(int i = 0; i < CHARSET.length; i++) {
			gl2.glNewList(charsetOffset + 0x20 + i, GL2.GL_COMPILE);
			gl2.glBitmap(8, 16, 0.0f, 0.0f, 8.0f, 0.0f, CHARSET[i], 0);
			gl2.glEndList();
		}
	}
	
	@Override
	public void renderTextAnnotations(GLRenderContext<V, E> glRenderContext, Layout<V, E> layout, NetworkGLAnnotation currentTextAnnotation) {
		GLAutoDrawable glAutoDrawable = glRenderContext.getGLAutoDrawable();
		String label;
		label = (String) ((NetworkGLAnnotation) currentTextAnnotation).getAnnotation();
		float r = currentTextAnnotation.getColor().getRed()/255.0f;
		float g = currentTextAnnotation.getColor().getGreen()/255.0f;
		float b = currentTextAnnotation.getColor().getBlue()/255.0f;
		
		if(label.length() > 0) {
			GL2 gl2 = glAutoDrawable.getGL().getGL2();
			
			Point2D p = ((NetworkGLAnnotation) currentTextAnnotation).getLocation();
			p = glRenderContext.getMultiLayerTransformer().transform(p);
	    	
			gl2.glColor3f(r, g, b);  
			gl2.glRasterPos2d(p.getX(), glAutoDrawable.getHeight() - p.getY());
			CharBuffer labelBuffer = CharBuffer.wrap(label.toCharArray());
			
			gl2.glPushAttrib(GL2.GL_LIST_BIT);
			gl2.glListBase(charsetOffset);
			gl2.glCallLists(2*labelBuffer.length(), GL2.GL_BYTE, labelBuffer);
			gl2.glPopAttrib();
			gl2.glFlush();
		}
	}
}
